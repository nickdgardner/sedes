#!/usr/bin/env python3

import csv
import getopt
import re
import sys

import tei

def split_line(s):
    return re.findall("[\\w\u0313\u0314\u0301\u0342\u0300\u0308\u0345\u0323]+", s)

def process(f):
    global csv_w
    doc = tei.TEI(f)
    for line in doc.lines():
        for word_n, word in enumerate(split_line(line.text)):
            if not word:
                continue
            csv_w.writerow({
                "line_n": line.n,
                "word_n": word_n + 1,
                "word": word,
            })

def input_files(args):
    if len(args) == 0:
        yield sys.stdin
        return
    for arg in args:
        with open(arg) as f:
            yield f

csv_w = csv.DictWriter(sys.stdout, ["line_n", "word_n", "word"])
csv_w.writeheader()

opts, args = getopt.gnu_getopt(sys.argv[1:], "")
for f in input_files(args):
    process(f)
