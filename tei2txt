#!/usr/bin/env python

import bs4
import getopt
import sys

import beta

class Context(object):
    def __init__(self, outfile):
        self.outfile = outfile
        self.lineno = 0

    def check_lineno(self, elem):
        n = elem.get("n")
        if n is not None:
            n = int(n)
            if self.lineno != n:
                print >> sys.stderr, "warning: expected line %d on line %d" % (self.lineno, n)
                self.lineno = n

    def write_beta_line(self, betacode):
        self.outfile.write((beta.decode(betacode) + u"\n").encode("utf-8"))

def convert_text(soup, ctx):
    parts = []
    for x in soup.children:
        if type(x) == bs4.element.Tag:
            if x.name in ("lb",):
                betacode = u"".join(parts).strip()
                if betacode:
                    ctx.write_beta_line(betacode)
                ctx.lineno += 1
                ctx.check_lineno(x)
                parts = []
            elif x.name in ("milestone",):
                pass
            else:
                raise ValueError("don't understand element %r" % x.name)
        elif type(x) == bs4.element.Comment:
            pass
        else:
            parts.append(unicode(x))
    betacode = u"".join(parts).strip()
    if betacode:
        ctx.write_beta_line(betacode)

def convert_elem(soup, ctx):
    for elem in soup.find_all(recursive=False):
        if elem.name in ("div1",):
            ctx.lineno = 0
            convert_elem(elem, ctx)
        elif elem.name in ("milestone", "q", "sp"):
            convert_elem(elem, ctx)
        elif elem.name in ("p", "l"):
            ctx.lineno += 1
            ctx.check_lineno(elem)
            convert_text(elem, ctx)
        else:
            raise ValueError("don't understand element %r" % elem.name)

def convert(infile, outfile):
    soup = bs4.BeautifulSoup(infile, "xml")
    ctx = Context(outfile)
    return convert_elem(soup.find("text").find("body"), ctx)

def input_files(args):
    if len(args) == 0:
        yield sys.stdin
        return
    for arg in args:
        with open(arg) as f:
            yield f

opts, args = getopt.gnu_getopt(sys.argv[1:], "")
for f in input_files(args):
    convert(f, sys.stdout)
